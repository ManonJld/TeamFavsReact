import jwtDecode from "jwt-decode"

export function loginUser(){
    return (dispatch, getState) => {
        console.log("loginUser")
        const state = getState();
        const email = state.front.loginUser.email;
        const password = state.front.loginUser.password;
        // const credentials = state.front.loginUser;
        dispatch(loginUserPending());
        fetch(process.env.REACT_APP_API_URL + "/login_check", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: email, password: password})
        })
            .then(response => response.json())
            .then(data => dispatch(loginUserSuccess(data)))
            .then(data => window.localStorage.setItem("authToken", data.token), setAuthHeader())
            .catch(err => {
                console.log(err)
                return dispatch(loginUserFailure(err))
            })
    }
}

export const LOGIN_USER_PENDING = 'LOGIN_USER_PENDING';
function loginUserPending(){
    return {type: LOGIN_USER_PENDING};
}

export const LOGIN_USER_SUCCESS = 'LOGIN_USER_SUCCESS';
function loginUserSuccess(loginUser){
    return {type: LOGIN_USER_SUCCESS, payload: loginUser};
}

export const LOGIN_USER_FAILURE = 'LOGIN_USER_FAILURE';
function loginUserFailure(error){
    return {type: LOGIN_USER_FAILURE, payload: error}
}

export function setAuthHeader(){
    let user = JSON.parse(localStorage.getItem('user'))
    if (user && user.token) {
        return { 'Authorization': 'Bearer ' + user.token };
    } else {
        return {};
    }
}

//Permet de savoir si on est authentifié ou pas
export function isAuthenticated(){
    //voir si on a un token
    const token = window.localStorage.getItem("authToken");
    //voir si le token est encore valide
    if (token){
        const jwtData = jwtDecode(token)
        //calcul par rapport à l'info d'expiration dans le token
        if(jwtData.exp*1000 > new Date().getTime()){
            //si oui, donner le token à axios
            return true
        }
        return false;
    }
    return false;
}
//form login actions

export const CHANGE_INPUT_LOGIN_EMAIL = 'CHANGE_INPUT_LOGIN_EMAIL';
export function changeInputLoginEmail(value){
    return {type: CHANGE_INPUT_LOGIN_EMAIL, payload: value};
}

export const CHANGE_INPUT_LOGIN_PASSWORD = 'CHANGE_INPUT_LOGIN_PASSWORD';
export function changeInputLoginPassword(value){
    return {type: CHANGE_INPUT_LOGIN_PASSWORD, payload: value};
}